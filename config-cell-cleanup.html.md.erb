---
title: Configuring Cell Disk Cleanup Scheduling
owner: Ops Manager
---

<strong><%= modified_date %></strong>

This topic describes how to configure disk cleanup scheduling
on Diego cells in Pivotal Cloud Foundry (PCF).


## <a id='what'></a> What is Disk Cleanup

PCF isolates application instances (AIs) from each other using containers that run inside Diego cells. Containers enforce a set of isolation layers including file system isolation. A PCF container file system can either be a PCF stack or the result of pulling a Docker image.

For performance reasons, the cells cache the Docker image layers and the PCF stacks that running AIs use. When PCF destroys an AI (e.g.: as a result of `cf delete`) or when PCF reschedules an AI to a different cell, there is a chance that certain Docker image layers, or an old PCF stack will become unused. If PCF does not clean these unused layers the cell ephemeral disk will slowly fill.

Disk cleanup is the process of removing unused layers from the cell disk. The disk cleanup process will remove all unused Docker image layers and old PCF Stacks, regardless of their size or age.


## <a id='options'></a> Options for Disk Cleanup

PCF provides the following options for scheduling the disk cleanup process on Diego cells: 

* **Never clean up the Cell Disk**: Pivotal does not recommend using this option for production environments.

* **Routinely clean up the Cell Disk**: This option makes the cell schedule a disk cleanup every time a container gets created. Running the disk cleanup process so frequently may have a negative impact on the cell performance.

* **Clean up Disk space once a threshold is reached**: Choosing this option makes the cell schedule the disk cleanup process only when a configurable disk space threshold is reached or exceeded.

See the [Configure Disk Cleanup Scheduling](#applying-configuration) section for how to choose one these options.

### <a id='recommendations'></a> Recommendations

Choosing the best option for disk cleanup depends on the workload that the Diego cells run: Docker images or Cloud Foundry buildpack-based apps.

For PCF installations that mainly run **buildpack-based applications**, Pivotal recommends using the second option: **Routinely clean up Cell Disk space**. The **Routinely clean up Cell Disk space** option ensures that when a new stack becomes available on a cell, the old stack is dropped immediately from the cache.

For PCF installations that mainly run **Docker images**, or both Docker images and buildpack-based apps,
Pivotal recommends using the third option: **Clean up Disk space once a threshold is reached** along with a reasonable threshold. Choosing a threshold is described in [Choosing a Threshold](#choosing-a-threshold).

### <a id='choosing-a-threshold'></a> Choosing a Threshold

To choose a realistic value when configuring the disk cleanup threshold, you must identify some of the most frequently used Docker images in your PCF installation. Docker images tend to be constructed by creating layers over existing, base, images. In some cases, you may find it easier to identify which base Docker images are most frequently used.  

To configure the disk cleanup threshold, do the following:

1. Identify the most frequently used Docker images or base Docker images. 
<br><br>Example: The most frequently used images in a test deployment are `openjdk:7`, `nginx:1.13`, and `php:7-apache`.

1. Using the Docker CLI, measure the size of those images.
<br><br>
Example:
    <pre class="terminal">
    \# Pull identified images locally
    $> docker pull openjdk:7
    $> docker pull nginx:1.13
    $> docker pull php:7-apache

    \# Measure their sizes
    $> docker images
    REPOSITORY       TAG          IMAGE ID          CREATED             SIZE
    php              7-apache     2720c02fc079      2 days ago          391 MB
    openjdk          7            f45207c01009      5 days ago          586 MB
    nginx            1.13         3448f27c273f      5 days ago          109 MB
    ...
    </pre>

1. Calculate the threshold as the sum of the frequently used image sizes plus a reasonable buffer such as 15-20%.
<br><br>
Example: Using the output above, the sample threshold calculation is (&nbsp;391&nbsp;MB&nbsp;+&nbsp;586&nbsp;MB&nbsp;+&nbsp;109&nbsp;MB&nbsp;)&nbsp;*&nbsp;1.2&nbsp;=&nbsp;1303.2&nbsp;MB


## <a id='applying-configuration'></a> Configure Disk Cleanup Scheduling

1. Navigate to the PCF Operations Manager **Installation Dashboard**.

1. Click the **Pivotal Elastic Runtime** tile, and navigate to the **Application Containers** tab.
  <%= image_tag("images/docker-registry-ert.png") %>

1. Under **Docker Images Disk-Cleanup Scheduling on Cell VMs**, select the option that you prefer.

1. If you select the **Clean up Disk space once threshold is reached** option, fill in the **Threshold of Disk Used (MB)** field. You will need to enter the disk space threshold amount, in MB, that you calculated for your deployment, as described in [Choosing a Threshold](#choosing-a-threshold).
  <br><br>
  Example: As calculated in the previous step, you would enter **1303**.

1. Click **Save**.

### <a id="next"></a> Next Steps

If you are configuring Elastic Runtime for the first time, then return to your specific IaaS configuration to continue the installation process.

If you are modifying an existing Elastic Runtime installation, return to the **PCF Ops Manager Installation Dashboard** and click **Apply Changes**.